#!/bin/sh

#mvn clean install -U -DskipTests -DskipCopyDependencies=false

# resolve links - $0 may be a link to Trantor home
PRG="$0"
# need this for relative symlinks
while [ -h "$PRG" ]; do
  ls=$(ls -ld "$PRG")
  link=$(expr "$ls" : '.*-> \(.*\)$')
  if expr "$link" : '/.*' >/dev/null; then
    PRG="$link"
  else
    PRG="$(dirname "$PRG")/$link"
  fi
done
TRANTOR2_HOME=$(dirname "$PRG")/..
# make it fully qualified
TRANTOR2_HOME=$(cd "$TRANTOR2_HOME" && pwd)
# check the Java execution environment
if [ -z "$JAVA_HOME" ]; then
  JAVACMD=$(which java)
else
  JAVACMD="$JAVA_HOME/bin/java"
fi
if [ ! -x "$JAVACMD" ]; then
  echo "The JAVA_HOME environment variable is not defined correctly" >&2
  echo "This environment variable is needed to run this program" >&2
  echo "NB: JAVA_HOME should point to a JDK not a JRE" >&2
  exit 1
fi

CLASSWORLDS_LAUNCHER=io.terminus.trantor2.MainKt

for i in $TRANTOR_HOME/libexec/lib/*.jar; do
  CLASSWORLDS_JAR="$CLASSWORLDS_JAR":"$i"
done

for i in $TRANTOR2_HOME/libexec/*.jar; do
  CLASSWORLDS_JAR="$CLASSWORLDS_JAR":"$i"
done

# set environment variable
export TRANTOR2_HOME="$TRANTOR2_HOME"

TRANTOR_JVM_LOG_HOME=-XX:ErrorFile=$TRANTOR2_HOME/log/trantorCli.log
export TRANTOR_JVM_LOG_HOME

# run trantor cli
exec "$JAVACMD" \
  $TRANTOR_DEBUG_OPTS \
  -client \
  -classpath "${CLASSWORLDS_JAR}" \
  ${CLASSWORLDS_LAUNCHER} "$@"